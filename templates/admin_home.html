{% extends "admin_base.html" %}

{% block page_title %}Dashboard{% endblock %}
{% block header_title_inner %}EsenTrader Admin Panel{% endblock %}
{% block header_subtitle %}
Boru API ve IBKR altyapısı için canlı durum ekranı.
{% endblock %}

{% block content %}

<div class="cards-row">
  <!-- Boru API -->
  <div class="card">
    <div class="card-header">Boru API</div>
    <div class="card-title">
      {% if api_ok %}
        ONLINE
      {% else %}
        OFFLINE
      {% endif %}
    </div>
    <div class="card-meta">
      127.0.0.1:5055 <code>/api/status</code> yanıtına göre.
    </div>
    <button class="btn-secondary-soft" onclick="refreshStatus()">
      Yenile
    </button>
  </div>

  <!-- Aktif Mod -->
  <div class="card">
    <div class="card-header">Aktif Mod</div>
    <div class="card-title">
      {{ mode or 'LOCAL' }}
    </div>
    <div class="card-meta">
      LOCAL = PC üstü, VPS = uzak sunucu akışı.
    </div>
    <form id="modeForm" onsubmit="return toggleMode();">
      <button type="submit" class="btn-secondary-soft">
        LOCAL / VPS Değiştir
      </button>
    </form>
  </div>

  <!-- IBKR Paneli -->
  <div class="card">
    <div class="card-header">IBKR Paneli</div>
    <div class="card-title">IBKR Durumu</div>
    <div class="card-meta">
      Detaylı IBKR özet ve pozisyon durumu için özel sayfa.
    </div>
    <a href="/admin/ibkr" class="btn-primary-soft">
      IBKR Ekranına Git
    </a>
  </div>

  <!-- Analytics -->
  <div class="card">
    <div class="card-header">Analytics</div>
    <div class="card-title">İstatistik Paneli</div>
    <div class="card-meta">
      Alarm sayısı, trade hacmi, abone istatistikleri v.b.
    </div>
    <a href="/admin/analytics" class="btn-primary-soft">
      Analytics Sayfası
    </a>
  </div>
</div>

<div class="card-section">
  <div class="card-section-title">Boru API Durumu (Detay)</div>
  <div class="card-section-sub">
    Aşağıdaki JSON, doğrudan <code>/api/status</code> cevabıdır. Boru hattı,
    versiyon ve mesaj bilgilerini buradan görebilirsin.
  </div>
  <pre id="apiStatusJson">{ "loading": true }</pre>
</div>

<div class="card-section">
  <div class="card-section-title">Servis Detayları</div>
  <div class="card-section-sub">
    Altyapıdaki çekirdek servislerin özet durumu. IBKR durumunu manuel olarak kontrol
    ediyorsun, Boru API ve Admin panel durumu ise otomatik.
  </div>

  <table>
    <thead>
      <tr>
        <th>SERVİS</th>
        <th>AÇIKLAMA</th>
        <th>DURUM</th>
      </tr>
    </thead>
    <tbody>
      <tr>
        <td>Boru API</td>
        <td>TradingView sinyalleri ve emir kanalının ana boru hattı</td>
        <td>
          <span class="status-dot {% if api_ok %}status-online{% else %}status-offline{% endif %}"></span>
          {% if api_ok %}
            ONLINE
          {% else %}
            OFFLINE
          {% endif %}
        </td>
      </tr>
      <tr>
        <td>Admin Panel</td>
        <td>Bu gördüğün ekran (<code>admin_app.py</code>)</td>
        <td>
          <span class="status-dot status-online"></span>
          ÇALIŞIYOR
        </td>
      </tr>
      <tr>
        <td>IBKR Gateway</td>
        <td>Windows tarafında çalışan IB Gateway / TWS</td>
        <td>
          <span class="status-dot status-manual"></span>
          Manuel Kontrol
        </td>
      </tr>
    </tbody>
  </table>
</div>

<script>
  const apiStatusData = {{ api_status | tojson | safe }};

  function renderStatus() {
    const pre = document.getElementById('apiStatusJson');
    try {
      pre.textContent = JSON.stringify(apiStatusData, null, 2);
    } catch (e) {
      pre.textContent = 'Geçersiz JSON / api_status verisi yok.';
    }
  }

  async function refreshStatus() {
    try {
      const res = await fetch('/api/status');
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const data = await res.json();
      const pre = document.getElementById('apiStatusJson');
      pre.textContent = JSON.stringify(data, null, 2);
    } catch (err) {
      const pre = document.getElementById('apiStatusJson');
      pre.textContent = 'API hata verdi veya erişilemedi: ' + err.message;
    }
  }

  async function toggleMode() {
    const current = '{{ mode or "LOCAL" }}';
    const next = current === 'LOCAL' ? 'VPS' : 'LOCAL';
    try {
      const res = await fetch('/admin/set-mode/' + next, { method: 'POST' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      window.location.reload();
    } catch (err) {
      alert('Mod değiştirilemedi: ' + err.message);
    }
    return false;
  }

  renderStatus();
</script>

{% endblock %}
