{% extends "admin_base.html" %}

{% block page_title %}Trade Panel{% endblock %}
{% block header_title_inner %}Trade Panel{% endblock %}
{% block header_subtitle %}
IBKR ana hesap için manuel emir ekranı ve açık pozisyon özeti.
{% endblock %}

{% block content %}
<style>
  .trade-grid-top {
    display: grid;
    grid-template-columns: minmax(0, 2.2fr) minmax(0, 2fr);
    gap: 16px;
    margin-bottom: 16px;
  }

  .trade-grid-bottom {
    display: grid;
    grid-template-columns: minmax(0, 2.2fr) minmax(0, 2fr);
    gap: 16px;
  }

  .trade-card {
    background: var(--bg-card);
    border-radius: 14px;
    border: 1px solid var(--border-soft);
    padding: 14px 16px 12px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.55);
  }

  .trade-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 8px;
  }

  .trade-card-title {
    font-size: 14px;
    font-weight: 500;
  }

  .trade-card-sub {
    font-size: 11px;
    color: var(--text-soft);
  }

  .trade-main-value {
    font-size: 22px;
    font-weight: 600;
    margin: 4px 0 8px;
  }

  .trade-main-value.error {
    color: var(--danger);
  }

  .trade-account-row {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    margin-top: 6px;
  }

  .stat-box {
    background: var(--bg-card-soft);
    border-radius: 10px;
    border: 1px solid var(--border-soft);
    padding: 8px 10px;
  }

  .stat-label {
    font-size: 11px;
    color: var(--text-soft);
    margin-bottom: 4px;
  }

  .stat-value {
    font-size: 13px;
    font-weight: 500;
  }

  .trade-btn-refresh {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: var(--bg-card-soft);
    color: var(--text-soft);
    cursor: pointer;
  }

  .trade-btn-refresh:hover {
    border-color: #2c3a54;
    color: var(--text-main);
  }

  .order-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
    margin-top: 8px;
  }

  .order-grid-full {
    grid-column: 1 / -1;
  }

  .form-label {
    font-size: 11px;
    color: var(--text-soft);
    margin-bottom: 3px;
  }

  .form-input,
  .form-select {
    width: 100%;
    background: var(--bg-card-soft);
    border-radius: 8px;
    border: 1px solid var(--border-soft);
    padding: 7px 9px;
    font-size: 12px;
    color: var(--text-main);
  }

  .form-input::placeholder {
    color: #64748b;
  }

  .order-actions {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 8px;
    margin-top: 10px;
  }

  .btn-buy {
    border-radius: 999px;
    padding: 8px 10px;
    border: 1px solid rgba(34, 197, 94, 0.8);
    background: linear-gradient(135deg, rgba(21, 128, 61, 0.5), rgba(34, 197, 94, 0.7));
    color: #e5ffe9;
    font-size: 13px;
    cursor: pointer;
  }

  .btn-sell {
    border-radius: 999px;
    padding: 8px 10px;
    border: 1px solid rgba(248, 113, 113, 0.9);
    background: linear-gradient(135deg, rgba(127, 29, 29, 0.7), rgba(248, 113, 113, 0.8));
    color: #ffe5e5;
    font-size: 13px;
    cursor: pointer;
  }

  .btn-buy:hover {
    filter: brightness(1.05);
  }

  .btn-sell:hover {
    filter: brightness(1.05);
  }

  .order-status {
    margin-top: 6px;
    font-size: 11px;
    color: var(--text-soft);
    min-height: 16px;
  }

  .order-status.ok {
    color: #4ade80;
  }

  .order-status.err {
    color: #fca5a5;
  }

  .positions-empty {
    font-size: 12px;
    color: #fca5a5;
    margin-top: 4px;
  }

  #trade-json {
    width: 100%;
    min-height: 180px;
    max-height: 260px;
    resize: vertical;
    background: var(--bg-card-soft);
    border-radius: 10px;
    border: 1px solid var(--border-soft);
    padding: 10px 12px;
    font-size: 12px;
    color: #d1e3ff;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    white-space: pre;
    overflow: auto;
  }

  @media (max-width: 1100px) {
    .trade-grid-top,
    .trade-grid-bottom {
      grid-template-columns: minmax(0, 1fr);
    }
  }
</style>

<div class="trade-grid-top">

  <!-- === SYMBOL CHART (TradingView) === -->
  <div class="trade-card esen-card mb-4">
    <div class="trade-card-header">
      <div>
        <div class="trade-card-title">Grafik</div>
        <div class="trade-card-sub">
          Sembol alanına yazdığın hisse burada çizilir. Örn: GLDM, NVDA, MSFT...
        </div>
      </div>
    </div>
    <div class="trade-card-body" style="height: 420px;">
      <div id="tv_chart_container" style="width: 100%; height: 100%;"></div>
    </div>
  </div>

  <!-- === HESAP ÖZETİ === -->
  <div class="trade-card">
    <div class="trade-card-header">
      <div>
        <div class="trade-card-title">Hesap Özeti</div>
        <div class="trade-card-sub">Boru API’den IBKR ana hesap bilgisi. Toplam Net Değer (Equity).</div>
      </div>
      <button id="btn-refresh-all" class="trade-btn-refresh">Yenile</button>
    </div>

    <div class="trade-main-value" id="account-equity">Hata</div>

    <div class="trade-account-row">
      <div class="stat-box">
        <div class="stat-label">Nakit</div>
        <div class="stat-value" id="account-cash"></div>
      </div>

      <div class="stat-box">
        <div class="stat-label">Buying Power</div>
        <div class="stat-value" id="account-buying-power"></div>
      </div>

      <div class="stat-box">
        <div class="stat-label">Currency</div>
        <div class="stat-value" id="account-currency"></div>
      </div>
    </div>
  </div>
</div>

  <!-- MANUEL EMİR PANELİ -->



<!-- Manuel Emir Paneli -->
<div class="col-lg-4 col-md-5">
  <div class="card mb-4">
    <div class="card-header pb-0">
      <h6 class="mb-0">Manuel Emir Paneli</h6>
      <p class="text-xs text-secondary mb-0">
        Sembol yaz → yön / miktar / TP / SL gir → Emri Gönder
      </p>
    </div>
    <div class="card-body pt-3">
      <form id="manual-order-form" onsubmit="return sendManualOrder(event);">
        
        <!-- Sembol -->
        <div class="mb-3">
          <label for="order-symbol" class="form-label text-sm">Sembol</label>
          <input
            type="text"
            class="form-control form-control-sm"
            id="order-symbol"
            name="symbol"
            placeholder="Örn: GLDM, NVDA"
            autocomplete="off"
          >
          <small class="text-xs text-secondary">
            Bu alan, TradingView grafiğiyle bağlantılıdır.  
            Buraya ne yazarsan grafik de o sembole geçer.
          </small>
        </div>

        <!-- Yön (Al / Sat) -->
        <div class="mb-3">
          <label class="form-label text-sm d-block mb-1">Yön</label>
          <div class="d-flex gap-2">
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="side"
                id="order-side-buy"
                value="BUY"
                checked
              >
              <label class="form-check-label text-sm" for="order-side-buy">
                AL (Long)
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="side"
                id="order-side-sell"
                value="SELL"
              >
              <label class="form-check-label text-sm" for="order-side-sell">
                SAT (Pozisyon Kapat / Short değil)
              </label>
            </div>
          </div>
        </div>

        <!-- Miktar & USD Tutar -->
        <div class="mb-3">
          <label class="form-label text-sm d-block mb-1">Miktar</label>
          <div class="row g-2">
            <div class="col-6">
              <input
                type="number"
                step="0.0001"
                min="0"
                class="form-control form-control-sm"
                id="order-qty"
                name="quantity"
                placeholder="Adet"
              >
              <small class="text-xs text-secondary">Adet (lot)</small>
            </div>
            <div class="col-6">
              <input
                type="number"
                step="0.01"
                min="0"
                class="form-control form-control-sm"
                id="order-usd"
                name="usd_amount"
                placeholder="USD"
              >
              <small class="text-xs text-secondary">USD Tutar (opsiyonel)</small>
            </div>
          </div>
          <small class="text-xs text-secondary d-block mt-1">
            Emir gönderirken backend, <strong>öncelik sırası</strong>:
            <strong>USD tutar → Adet</strong> olarak hesaplama yapabilir.
          </small>
        </div>

        <!-- TP / SL (%) -->
        <div class="mb-3">
          <label class="form-label text-sm d-block mb-1">
            TP / Zarar Kes (SL)
          </label>
          <div class="row g-2">
            <div class="col-6">
              <div class="input-group input-group-sm">
                <input
                  type="number"
                  step="0.1"
                  class="form-control"
                  id="order-tp-percent"
                  name="tp_percent"
                  placeholder="2.4"
                >
                <span class="input-group-text">%</span>
              </div>
              <small class="text-xs text-secondary">TP (%) – Kâr Al</small>
            </div>
            <div class="col-6">
              <div class="input-group input-group-sm">
                <input
                  type="number"
                  step="0.1"
                  class="form-control"
                  id="order-sl-percent"
                  name="sl_percent"
                  placeholder="2.0"
                >
                <span class="input-group-text">%</span>
              </div>
              <small class="text-xs text-secondary">SL (%) – Zarar Kes</small>
            </div>
          </div>
          <small class="text-xs text-secondary d-block mt-1">
            Örnek: TP 2.4 → giriş fiyatından <strong>%2.4</strong> kârda
            otomatik çıkış. SL 2.0 → giriş fiyatından <strong>%2</strong> zararda
            kes.
          </small>
        </div>

        <!-- Not / Etiket (opsiyonel) -->
        <div class="mb-3">
          <label for="order-note" class="form-label text-sm">Not / Etiket (opsiyonel)</label>
          <input
            type="text"
            class="form-control form-control-sm"
            id="order-note"
            name="note"
            placeholder="Örn: GLDM Kademe 3, Esen V3 sinyali"
          >
        </div>

        <!-- Gönder Butonu -->
        <div class="d-grid">
          <button
            type="submit"
            class="btn btn-success btn-sm"
            id="order-submit-btn"
          >
            Emri Gönder
          </button>
        </div>

        <!-- Hata / Bilgi Mesajı -->
        <div class="mt-2">
          <small id="order-message" class="text-xs text-secondary"></small>
        </div>
      </form>
    </div>
  </div>
</div>
<!-- /Manuel Emir Paneli -->


  <!-- AÇIK POZİSYONLAR -->
  <div class="trade-card">
    <div class="trade-card-header">
      <div>
        <div class="trade-card-title">Açık Pozisyonlar</div>
        <div class="trade-card-sub">/api/positions cevabından özet tablo.</div>
      </div>
      <button id="btn-refresh-positions" class="trade-btn-refresh">Yenile</button>
    </div>

    <div id="positions-wrapper">
      <table id="positions-table">
        <thead>
        <tr>
          <th>SEMBOL</th>
          <th>ADET</th>
          <th>ORT. FİYAT</th>
          <th>GÜNCEL FİYAT</th>
          <th>K/Z ($)</th>
          <th>K/Z (%)</th>
        </tr>
        </thead>
        <tbody id="positions-body">
        <tr>
          <td colspan="6" class="positions-empty">Açık pozisyon yok.</td>
        </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- JSON DEBUG -->
  <div class="trade-card">
    <div class="trade-card-header">
      <div>
        <div class="trade-card-title">Ham JSON (Debug)</div>
        <div class="trade-card-sub">Hesap + pozisyon JSON çıktıları. Gerçek API cevabını burada görebilirsin (mapping kontrolü için).</div>
      </div>
    </div>

    <textarea id="trade-json" readonly>{}</textarea>
  </div>
</div>

<script>
  async function fetchJson(url) {
    const resp = await fetch(url, {cache: "no-store"});
    let data = null;
    try {
      data = await resp.json();
    } catch (e) {
      data = {ok: false, error: "JSON parse edilemedi", rawStatus: resp.status};
    }
    return data;
  }

  function formatNumber(value) {
    if (value === null || value === undefined || value === "-" || Number.isNaN(value)) {
      return "-";
    }
    const num = Number(value);
    if (!Number.isFinite(num)) return "-";
    return num.toLocaleString("en-US", {minimumFractionDigits: 2, maximumFractionDigits: 2});
  }

  function fillAccountCard(accData) {
    const equityEl = document.getElementById("account-equity");
    const cashEl = document.getElementById("account-cash");
    const bpEl = document.getElementById("account-buying-power");
    const curEl = document.getElementById("account-currency");

    let equity = null;
    let cash = null;
    let buying = null;
    let currency = "-";

    if (accData && accData.ok) {
      let acc = accData.account || accData.account_summary || null;

      // Birden fazla hesap varsa
      if (!acc && Array.isArray(accData.accounts) && accData.accounts.length > 0) {
        if (accData.accounts.length === 1) {
          acc = accData.accounts[0];
        } else {
          const accounts = accData.accounts;
          equity = accounts.reduce((s, a) => s + (Number(a.net_liquidation || a.equity || 0)), 0);
          cash = accounts.reduce((s, a) => s + (Number(a.cash || a.cash_balance || 0)), 0);
          buying = accounts.reduce((s, a) => s + (Number(a.buying_power || a.available_funds || 0)), 0);
          currency = accounts[0].currency || accounts[0].base_currency || "USD";
        }
      }

      if (acc) {
        if (equity === null) equity = acc.net_liquidation ?? acc.equity ?? acc.total_value ?? null;
        if (cash === null) cash = acc.cash ?? acc.cash_balance ?? null;
        if (buying === null) buying = acc.buying_power ?? acc.available_funds ?? null;
        if (!currency || currency === "-") {
          currency = acc.currency ?? acc.base_currency ?? "USD";
        }
      }
    }

    equityEl.textContent = equity === null ? "Hata" : formatNumber(equity);
    cashEl.textContent = formatNumber(cash);
    bpEl.textContent = formatNumber(buying);
    curEl.textContent = currency || "-";

    if (equity === null) {
      equityEl.classList.add("error");
    } else {
      equityEl.classList.remove("error");
    }
  }

  function normalizePositions(posData) {
    if (!posData || posData.ok === false) return [];

    let raw = [];
    if (Array.isArray(posData.positions)) {
      raw = posData.positions;
    } else if (posData.positions && Array.isArray(posData.positions.positions)) {
      raw = posData.positions.positions;
    } else if (Array.isArray(posData)) {
      raw = posData;
    }

    return raw.map(p => {
      const symbol = p.symbol || p.ticker || p.localSymbol || p.conid || "?";
      const qty = p.position ?? p.qty ?? p.quantity ?? 0;
      const avg = p.avg_price ?? p.average_price ?? p.avgCost ?? null;
      const last = p.last_price ?? p.market_price ?? p.current_price ?? null;
      const pnlUsd = p.unrealized_pnl ?? p.unrealizedPNL ?? p.pnl_usd ?? null;
      const pnlPct = p.unrealized_pnl_pct ?? p.pnl_pct ?? null;
      return {symbol, qty, avg, last, pnlUsd, pnlPct};
    });
  }

  function fillPositionsTable(posData) {
    const tbody = document.getElementById("positions-body");
    tbody.innerHTML = "";

    const list = normalizePositions(posData);

    if (!list.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 6;
      td.className = "positions-empty";
      td.textContent = "Pozisyonlar alınamadı veya açık pozisyon yok.";
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    for (const p of list) {
      const tr = document.createElement("tr");

      const tdSymbol = document.createElement("td");
      tdSymbol.textContent = p.symbol;

      const tdQty = document.createElement("td");
      tdQty.textContent = p.qty ?? p.quantity ?? p.position ?? 0;

      const tdAvg = document.createElement("td");
      tdAvg.textContent = formatNumber(p.avg);

      const tdLast = document.createElement("td");
      tdLast.textContent = formatNumber(p.last);

      const tdPnl = document.createElement("td");
      tdPnl.textContent = formatNumber(p.pnlUsd);

      const tdPnlPct = document.createElement("td");
      tdPnlPct.textContent = p.pnlPct == null ? "-" : formatNumber(p.pnlPct) + "%";

      tr.appendChild(tdSymbol);
      tr.appendChild(tdQty);
      tr.appendChild(tdAvg);
      tr.appendChild(tdLast);
      tr.appendChild(tdPnl);
      tr.appendChild(tdPnlPct);

      tbody.appendChild(tr);
    }
  }

  async function refreshAll() {
    const [accData, posData] = await Promise.all([
      fetchJson("/admin/api/account"),
      fetchJson("/admin/api/positions"),
    ]);

    // JSON debug
    const debugBox = document.getElementById("trade-json");
    debugBox.value = JSON.stringify({account: accData, positions: posData}, null, 2);

    fillAccountCard(accData);
    fillPositionsTable(posData);
  }

  async function sendOrder(side) {
    const statusEl = document.getElementById("order-status");
    statusEl.classList.remove("ok", "err");
    statusEl.textContent = "Emir gönderiliyor...";

    const symbol = document.getElementById("order-symbol").value.trim().toUpperCase();
    const orderType = document.getElementById("order-type").value;
    const qtyRaw = document.getElementById("order-qty").value;
    const usdRaw = document.getElementById("order-usd").value;
    const limitRaw = document.getElementById("order-limit").value;
    const note = document.getElementById("order-note").value.trim();

    const qty = qtyRaw ? Number(qtyRaw) : null;
    const usd = usdRaw ? Number(usdRaw) : null;
    const limitPrice = limitRaw ? Number(limitRaw) : null;

    if (!symbol) {
      statusEl.textContent = "Sembol gerekli.";
      statusEl.classList.add("err");
      return;
    }
    if (!qty && !usd) {
      statusEl.textContent = "En azından adet veya $ tutar girmelisin.";
      statusEl.classList.add("err");
      return;
    }

    const payload = {
      symbol: symbol,
      side: side,                 // BUY / SELL
      order_type: orderType,      // MARKET / LIMIT
      quantity: qty,
      usd_amount: usd,
      limit_price: limitPrice,
      note: note || null,
    };

    try {
      const resp = await fetch("/admin/api/order", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload),
      });

      const data = await resp.json().catch(() => null);

      if (resp.ok && data && data.ok !== false) {
        statusEl.textContent = "Emir gönderildi. Yanıt: " + JSON.stringify(data).slice(0, 180) + "...";
        statusEl.classList.add("ok");
        // Emirden sonra pozisyonları yenileyelim
        refreshAll().catch(() => {});
      } else {
        statusEl.textContent = "Emir hatası: " + JSON.stringify(data || {status: resp.status}).slice(0, 200);
        statusEl.classList.add("err");
      }
    } catch (e) {
      statusEl.textContent = "Ağ hatası: " + e;
      statusEl.classList.add("err");
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("btn-refresh-all").addEventListener("click", () => {
      refreshAll().catch(() => {});
    });
    document.getElementById("btn-refresh-positions").addEventListener("click", () => {
      refreshAll().catch(() => {});
    });
    document.getElementById("btn-order-buy").addEventListener("click", () => {
      sendOrder("BUY").catch(() => {});
    });
    document.getElementById("btn-order-sell").addEventListener("click", () => {
      sendOrder("SELL").catch(() => {});
    });

    // Sayfa açılır açılmaz veriyi çek
    refreshAll().catch(() => {});
  });
</script>


<!-- TradingView: Sembol Grafiği -->
<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
let tvWidget = null;

function loadTVChart(symbol) {
  try {
    if (!window.TradingView) {
      console.warn("TradingView yüklenmedi.");
      return;
    }

    // Eski widget'ı temizle
    if (tvWidget && tvWidget.remove) {
      tvWidget.remove();
    }

    // Yeni grafiği oluştur
    tvWidget = new TradingView.widget({
      container_id: "tv_chart_container",
      autosize: true,
      symbol: symbol,
      interval: "D",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      toolbar_bg: "#000000",
      hide_top_toolbar: false,
      hide_legend: false,
      withdateranges: true,
      allow_symbol_change: true,
      studies: ["MASimple@tv-basicstudies"],
    });
  } catch (e) {
    console.error("TradingView hata:", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const symbolInput = document.getElementById("order-symbol");

  // Sembol input'u yoksa bile en azından GLDM grafiğini yükle
  if (!symbolInput) {
    loadTVChart("GLDM");
    return;
  }

  // Sayfa açılır açılmaz ilk grafik
  loadTVChart(symbolInput.value.trim() || "GLDM");

  // Sembol alanı değişince grafiği güncelle
  symbolInput.addEventListener("input", () => {
    const sym = symbolInput.value.trim() || "GLDM";
    loadTVChart(sym);
  });
});


<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
<script>
// TradingView sembol grafiği
let tvWidget = null;

function loadTVChart(symbol) {
  try {
    if (!window.TradingView) {
      console.warn("TradingView yüklenmedi.");
      return;
    }

    if (tvWidget && tvWidget.remove) {
      tvWidget.remove();
    }

    tvWidget = new TradingView.widget({
      container_id: "tv_chart_container",
      autosize: true,
      symbol: symbol,
      interval: "D",
      timezone: "Etc/UTC",
      theme: "dark",
      style: "1",
      toolbar_bg: "#000000",
      hide_top_toolbar: false,
      hide_legend: false,
      withdateranges: true,
      allow_symbol_change: true,
      studies: ["MASimple@tv-basicstudies"],
    });
  } catch (e) {
    console.error("TradingView hata:", e);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  const symbolInput = document.getElementById("order-symbol");

  if (!symbolInput) {
    loadTVChart("GLDM");
    return;
  }

  loadTVChart(symbolInput.value.trim() || "GLDM");

  symbolInput.addEventListener("input", () => {
    const sym = symbolInput.value.trim() || "GLDM";
    loadTVChart(sym);
  });
});
</script>

<script>
function sendManualOrder(event) {
  // Normal submit’i durdur
  if (event) {
    event.preventDefault();
  }

  const ORDER_API_URL = "/admin/api/order";

  const symbolInput = document.getElementById("order-symbol");
  const qtyInput    = document.getElementById("order-qty");
  const usdInput    = document.getElementById("order-usd");
  const tpInput     = document.getElementById("order-tp-percent");
  const slInput     = document.getElementById("order-sl-percent");
  const noteInput   = document.getElementById("order-note");
  const messageBox  = document.getElementById("order-message");
  const submitBtn   = document.getElementById("order-submit-btn");

  function setMessage(text, isError = false) {
    if (!messageBox) return;
    messageBox.textContent = text || "";
    messageBox.style.color = isError ? "#ff4d4d" : "#9caac7";
  }

  if (!symbolInput) {
    setMessage("Form bulunamadı.", true);
    return false;
  }

  const symbolRaw = (symbolInput.value || "").trim();
  const symbol = symbolRaw.toUpperCase();
  const side = document.getElementById("order-side-sell").checked ? "SELL" : "BUY";

  const qtyVal  = qtyInput.value !== "" ? parseFloat(qtyInput.value) : null;
  const usdVal  = usdInput.value !== "" ? parseFloat(usdInput.value) : null;
  const tpVal   = tpInput.value  !== "" ? parseFloat(tpInput.value)  : null;
  const slVal   = slInput.value  !== "" ? parseFloat(slInput.value)  : null;
  const noteVal = (noteInput.value || "").trim() || null;

  if (!symbol) {
    setMessage("Lütfen sembol gir.", true);
    return false;
  }

  if ((qtyVal === null || isNaN(qtyVal)) && (usdVal === null || isNaN(usdVal))) {
    setMessage("En az Adet veya USD tutarından birini girmen gerekiyor.", true);
    return false;
  }

  if (qtyVal !== null && qtyVal <= 0) {
    setMessage("Adet 0'dan büyük olmalı.", true);
    return false;
  }

  if (usdVal !== null && usdVal <= 0) {
    setMessage("USD tutar 0'dan büyük olmalı.", true);
    return false;
  }

  const payload = {
    symbol: symbol,
    side: side,
    quantity: qtyVal,
    usd_amount: usdVal,
    tp_percent: tpVal,
    sl_percent: slVal,
    note: noteVal,
    source: "manual_panel"
  };

  (async () => {
    try {
      submitBtn.disabled = true;
      submitBtn.textContent = "Gönderiliyor...";
      setMessage("Emir gönderiliyor...", false);

      const response = await fetch(ORDER_API_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      if (!response.ok) {
        const txt = await response.text();
        console.error("Order error:", txt);
        setMessage("Emir gönderilemedi. Sunucu hata döndürdü.", true);
      } else {
        let data = null;
        try {
          data = await response.json();
          console.log("Order response:", data);
        } catch (err) {
          // JSON olmayabilir, sorun değil
        }

        setMessage("Emir başarıyla gönderildi.", false);

        // Sembole dokunma, diğerlerini temizle
        qtyInput.value  = "";
        usdInput.value  = "";
        tpInput.value   = "";
        slInput.value   = "";
        noteInput.value = "";
      }
    } catch (err) {
      console.error("Network/JS error:", err);
      setMessage("Ağ/JS hatası: Emir gönderilemedi.", true);
    } finally {
      submitBtn.disabled = false;
      submitBtn.textContent = "Emri Gönder";
    }
  })();

  // Formun sayfayı yenilemesini tamamen engelle
  return false;
}
</script>

{% endblock %}

